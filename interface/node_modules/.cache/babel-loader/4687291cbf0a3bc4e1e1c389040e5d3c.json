{"ast":null,"code":"import _asyncToGenerator from\"/home/brent/Downloads/esp8266-react/interface/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/home/brent/Downloads/esp8266-react/interface/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/home/brent/Downloads/esp8266-react/interface/node_modules/@babel/runtime/regenerator/index.js\";import{useCallback,useContext,useEffect,useState}from'react';import{useSnackbar}from'notistack';import{useNavigate}from'react-router-dom';import*as AuthenticationApi from'../../api/authentication';import{ACCESS_TOKEN}from'../../api/endpoints';import{LoadingSpinner}from'../../components';import{FeaturesContext}from'../features';import{AuthenticationContext}from'./context';import{jsx as _jsx}from\"react/jsx-runtime\";var Authentication=function Authentication(_ref){var children=_ref.children;var _useContext=useContext(FeaturesContext),features=_useContext.features;var navigate=useNavigate();var _useSnackbar=useSnackbar(),enqueueSnackbar=_useSnackbar.enqueueSnackbar;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),initialized=_useState2[0],setInitialized=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),me=_useState4[0],setMe=_useState4[1];var signIn=function signIn(accessToken){try{AuthenticationApi.getStorage().setItem(ACCESS_TOKEN,accessToken);var decodedMe=AuthenticationApi.decodeMeJWT(accessToken);setMe(decodedMe);enqueueSnackbar(\"Logged in as \".concat(decodedMe.username),{variant:'success'});}catch(error){setMe(undefined);throw new Error(\"Failed to parse JWT \"+error.message);}};var signOut=function signOut(redirect){AuthenticationApi.clearAccessToken();setMe(undefined);if(redirect){navigate('/');}};var refresh=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var accessToken;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(features.security){_context.next=4;break;}setMe({admin:true,username:\"admin\"});setInitialized(true);return _context.abrupt(\"return\");case 4:accessToken=AuthenticationApi.getStorage().getItem(ACCESS_TOKEN);if(!accessToken){_context.next=19;break;}_context.prev=6;_context.next=9;return AuthenticationApi.verifyAuthorization();case 9:setMe(AuthenticationApi.decodeMeJWT(accessToken));setInitialized(true);_context.next=17;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](6);setMe(undefined);setInitialized(true);case 17:_context.next=21;break;case 19:setMe(undefined);setInitialized(true);case 21:case\"end\":return _context.stop();}}},_callee,null,[[6,13]]);})),[features]);useEffect(function(){refresh();},[refresh]);if(initialized){return/*#__PURE__*/_jsx(AuthenticationContext.Provider,{value:{signIn:signIn,signOut:signOut,me:me,refresh:refresh},children:children});}return/*#__PURE__*/_jsx(LoadingSpinner,{height:\"100vh\"});};export default Authentication;","map":null,"metadata":{},"sourceType":"module"}