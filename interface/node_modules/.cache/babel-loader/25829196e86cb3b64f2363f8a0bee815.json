{"ast":null,"code":"import _slicedToArray from\"/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import{useCallback,useEffect,useRef,useState}from'react';import Sockette from'sockette';import{debounce}from'lodash';import{addAccessTokenParameter}from'../api/authentication';export var useWs=function useWs(wsUrl){var wsThrottle=arguments.length>1&&arguments[1]!==undefined?arguments[1]:100;var ws=useRef();var clientId=useRef();var _useState=useState(false),_useState2=_slicedToArray(_useState,2),connected=_useState2[0],setConnected=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),data=_useState4[0],setData=_useState4[1];var _useState5=useState(),_useState6=_slicedToArray(_useState5,2),transmit=_useState6[0],setTransmit=_useState6[1];var _useState7=useState(),_useState8=_slicedToArray(_useState7,2),clear=_useState8[0],setClear=_useState8[1];var onMessage=useCallback(function(event){var rawData=event.data;if(typeof rawData==='string'||rawData instanceof String){var message=JSON.parse(rawData);switch(message.type){case\"id\":clientId.current=message.id;break;case\"payload\":if(clientId.current){setData(function(existingData){return clientId.current===message.origin_id&&existingData||message.payload;});}break;}}},[]);var doSaveData=useCallback(function(newData){var clearData=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(!ws.current){return;}if(clearData){setData(undefined);}ws.current.json(newData);},[]);var saveData=useRef(debounce(doSaveData,wsThrottle));var updateData=function updateData(newData){var transmitData=arguments.length>1&&arguments[1]!==undefined?arguments[1]:true;var clearData=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;setData(newData);setTransmit(transmitData);setClear(clearData);};useEffect(function(){if(!transmit){return;}data&&saveData.current(data,clear);setTransmit(false);setClear(false);},[doSaveData,data,transmit,clear]);useEffect(function(){var instance=new Sockette(addAccessTokenParameter(wsUrl),{onmessage:onMessage,onopen:function onopen(){setConnected(true);},onclose:function onclose(){clientId.current=undefined;setConnected(false);setData(undefined);}});ws.current=instance;return instance.close;},[wsUrl,onMessage]);return{connected:connected,data:data,updateData:updateData};};","map":{"version":3,"sources":["/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/src/utils/useWs.ts"],"names":["useCallback","useEffect","useRef","useState","Sockette","debounce","addAccessTokenParameter","useWs","wsUrl","wsThrottle","ws","clientId","connected","setConnected","data","setData","transmit","setTransmit","clear","setClear","onMessage","event","rawData","String","message","JSON","parse","type","current","id","existingData","origin_id","payload","doSaveData","newData","clearData","undefined","json","saveData","updateData","transmitData","instance","onmessage","onopen","onclose","close"],"mappings":"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","sourcesContent":["import { useCallback, useEffect, useRef, useState } from 'react';\nimport Sockette from 'sockette';\nimport { debounce } from 'lodash';\n\nimport { addAccessTokenParameter } from '../api/authentication';\n\ninterface WebSocketIdMessage {\n  type: \"id\";\n  id: string;\n}\n\ninterface WebSocketPayloadMessage<D> {\n  type: \"payload\";\n  origin_id: string;\n  payload: D;\n}\n\nexport type WebSocketMessage<D> = WebSocketIdMessage | WebSocketPayloadMessage<D>;\n\nexport const useWs = <D>(wsUrl: string, wsThrottle: number = 100) => {\n\n  const ws = useRef<Sockette>();\n  const clientId = useRef<string>();\n\n  const [connected, setConnected] = useState<boolean>(false);\n  const [data, setData] = useState<D>();\n  const [transmit, setTransmit] = useState<boolean>();\n  const [clear, setClear] = useState<boolean>();\n\n  const onMessage = useCallback((event: MessageEvent) => {\n    const rawData = event.data;\n    if (typeof rawData === 'string' || rawData instanceof String) {\n      const message = JSON.parse(rawData as string) as WebSocketMessage<D>;\n      switch (message.type) {\n        case \"id\":\n          clientId.current = message.id;\n          break;\n        case \"payload\":\n          if (clientId.current) {\n            setData((existingData) => (clientId.current === message.origin_id && existingData) || message.payload);\n          }\n          break;\n      }\n    }\n  }, []);\n\n  const doSaveData = useCallback((newData: D, clearData: boolean = false) => {\n    if (!ws.current) {\n      return;\n    }\n    if (clearData) {\n      setData(undefined);\n    }\n    ws.current.json(newData);\n  }, []);\n\n  const saveData = useRef(debounce(doSaveData, wsThrottle));\n\n  const updateData = (newData: React.SetStateAction<D | undefined>, transmitData: boolean = true, clearData: boolean = false) => {\n    setData(newData);\n    setTransmit(transmitData);\n    setClear(clearData);\n  };\n\n  useEffect(() => {\n    if (!transmit) {\n      return;\n    }\n    data && saveData.current(data, clear);\n    setTransmit(false);\n    setClear(false);\n  }, [doSaveData, data, transmit, clear]);\n\n  useEffect(() => {\n    const instance = new Sockette(addAccessTokenParameter(wsUrl), {\n      onmessage: onMessage,\n      onopen: () => {\n        setConnected(true);\n      },\n      onclose: () => {\n        clientId.current = undefined;\n        setConnected(false);\n        setData(undefined);\n      },\n    });\n    ws.current = instance;\n    return instance.close;\n  }, [wsUrl, onMessage]);\n\n  return { connected, data, updateData } as const;\n};\n"]},"metadata":{},"sourceType":"module"}