{"ast":null,"code":"import _asyncToGenerator from\"/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/node_modules/@babel/runtime/helpers/esm/asyncToGenerator.js\";import _slicedToArray from\"/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/node_modules/@babel/runtime/helpers/esm/slicedToArray.js\";import _regeneratorRuntime from\"/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/node_modules/@babel/runtime/regenerator/index.js\";import{useCallback,useContext,useEffect,useState}from'react';import{useSnackbar}from'notistack';import{useNavigate}from'react-router-dom';import*as AuthenticationApi from'../../api/authentication';import{ACCESS_TOKEN}from'../../api/endpoints';import{LoadingSpinner}from'../../components';import{FeaturesContext}from'../features';import{AuthenticationContext}from'./context';import{jsx as _jsx}from\"react/jsx-runtime\";var Authentication=function Authentication(_ref){var children=_ref.children;var _useContext=useContext(FeaturesContext),features=_useContext.features;var navigate=useNavigate();var _useSnackbar=useSnackbar(),enqueueSnackbar=_useSnackbar.enqueueSnackbar;var _useState=useState(false),_useState2=_slicedToArray(_useState,2),initialized=_useState2[0],setInitialized=_useState2[1];var _useState3=useState(),_useState4=_slicedToArray(_useState3,2),me=_useState4[0],setMe=_useState4[1];var signIn=function signIn(accessToken){try{AuthenticationApi.getStorage().setItem(ACCESS_TOKEN,accessToken);var decodedMe=AuthenticationApi.decodeMeJWT(accessToken);setMe(decodedMe);enqueueSnackbar(\"Logged in as \".concat(decodedMe.username),{variant:'success'});}catch(error){setMe(undefined);throw new Error(\"Failed to parse JWT \"+error.message);}};var signOut=function signOut(redirect){AuthenticationApi.clearAccessToken();setMe(undefined);if(redirect){navigate('/');}};var refresh=useCallback(/*#__PURE__*/_asyncToGenerator(/*#__PURE__*/_regeneratorRuntime.mark(function _callee(){var accessToken;return _regeneratorRuntime.wrap(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:if(features.security){_context.next=4;break;}setMe({admin:true,username:\"admin\"});setInitialized(true);return _context.abrupt(\"return\");case 4:accessToken=AuthenticationApi.getStorage().getItem(ACCESS_TOKEN);if(!accessToken){_context.next=19;break;}_context.prev=6;_context.next=9;return AuthenticationApi.verifyAuthorization();case 9:setMe(AuthenticationApi.decodeMeJWT(accessToken));setInitialized(true);_context.next=17;break;case 13:_context.prev=13;_context.t0=_context[\"catch\"](6);setMe(undefined);setInitialized(true);case 17:_context.next=21;break;case 19:setMe(undefined);setInitialized(true);case 21:case\"end\":return _context.stop();}}},_callee,null,[[6,13]]);})),[features]);useEffect(function(){refresh();},[refresh]);if(initialized){return/*#__PURE__*/_jsx(AuthenticationContext.Provider,{value:{signIn:signIn,signOut:signOut,me:me,refresh:refresh},children:children});}return/*#__PURE__*/_jsx(LoadingSpinner,{height:\"100vh\"});};export default Authentication;","map":{"version":3,"sources":["/home/brent/Documents/PlatformIO/Projects/ESP32_C3_Test/interface/src/contexts/authentication/Authentication.tsx"],"names":["useCallback","useContext","useEffect","useState","useSnackbar","useNavigate","AuthenticationApi","ACCESS_TOKEN","LoadingSpinner","FeaturesContext","AuthenticationContext","Authentication","children","features","navigate","enqueueSnackbar","initialized","setInitialized","me","setMe","signIn","accessToken","getStorage","setItem","decodedMe","decodeMeJWT","username","variant","error","undefined","Error","message","signOut","redirect","clearAccessToken","refresh","security","admin","getItem","verifyAuthorization"],"mappings":"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","sourcesContent":["import { FC, useCallback, useContext, useEffect, useState } from 'react';\nimport { useSnackbar } from 'notistack';\nimport { useNavigate } from 'react-router-dom';\n\nimport * as AuthenticationApi from '../../api/authentication';\nimport { ACCESS_TOKEN } from '../../api/endpoints';\nimport { RequiredChildrenProps } from '../../utils';\nimport { LoadingSpinner } from '../../components';\nimport { Me } from '../../types';\n\nimport { FeaturesContext } from '../features';\nimport { AuthenticationContext } from './context';\n\nconst Authentication: FC<RequiredChildrenProps> = ({ children }) => {\n  const { features } = useContext(FeaturesContext);\n  const navigate = useNavigate();\n  const { enqueueSnackbar } = useSnackbar();\n\n  const [initialized, setInitialized] = useState<boolean>(false);\n  const [me, setMe] = useState<Me>();\n\n  const signIn = (accessToken: string) => {\n    try {\n      AuthenticationApi.getStorage().setItem(ACCESS_TOKEN, accessToken);\n      const decodedMe = AuthenticationApi.decodeMeJWT(accessToken);\n      setMe(decodedMe);\n      enqueueSnackbar(`Logged in as ${decodedMe.username}`, { variant: 'success' });\n    } catch (error: any) {\n      setMe(undefined);\n      throw new Error(\"Failed to parse JWT \" + error.message);\n    }\n  };\n\n  const signOut = (redirect: boolean) => {\n    AuthenticationApi.clearAccessToken();\n    setMe(undefined);\n    if (redirect) {\n      navigate('/');\n    }\n  };\n\n  const refresh = useCallback(async () => {\n    if (!features.security) {\n      setMe({ admin: true, username: \"admin\" });\n      setInitialized(true);\n      return;\n    }\n    const accessToken = AuthenticationApi.getStorage().getItem(ACCESS_TOKEN);\n    if (accessToken) {\n      try {\n        await AuthenticationApi.verifyAuthorization();\n        setMe(AuthenticationApi.decodeMeJWT(accessToken));\n        setInitialized(true);\n      } catch (error: any) {\n        setMe(undefined);\n        setInitialized(true);\n      }\n    } else {\n      setMe(undefined);\n      setInitialized(true);\n    }\n  }, [features]);\n\n  useEffect(() => {\n    refresh();\n  }, [refresh]);\n\n  if (initialized) {\n    return (\n      <AuthenticationContext.Provider\n        value={{\n          signIn,\n          signOut,\n          me,\n          refresh\n        }}\n      >\n        {children}\n      </AuthenticationContext.Provider >\n    );\n  }\n\n  return (\n    <LoadingSpinner height=\"100vh\" />\n  );\n};\n\nexport default Authentication;\n"]},"metadata":{},"sourceType":"module"}